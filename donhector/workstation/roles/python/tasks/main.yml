---
# tasks file for python

- name: Update apt cache.
  become: true
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 86400
    install_recommends: false
  when: ansible_os_family == 'Debian'


- name: Install OS packages
  become: true
  ansible.builtin.package:
    name: '{{ python_packages }}'
    state: present
  retries: 3
  register: apt_result
  until: apt_result is succeeded


- name: Register system pip version
  ansible.builtin.command: pip -V
  changed_when: false
  register: system_pip_version


- name: Show system pip version
  debug:
    msg: "System pip version: {{ system_pip_version.stdout }}"


- name: Ensure python_modules are installed.
  ansible.builtin.pip:
    name: "{{ item.name | default(item) }}"
    version: "{{ item.version | default(omit) }}"
    virtualenv: "{{ item.virtualenv | default(omit) }}"
    state: "{{ item.state | default(omit) }}"
    extra_args: "{{ item.extra_args | default(omit) }}"
  loop: "{{ python_modules }}"


- name: Register user pip version
  ansible.builtin.command: pip -V
  environment:
    PATH: "{{ ansible_env.HOME }}/.local/bin/:{{ ansible_env.PATH }}"
  changed_when: false
  register: user_pip_version


- name: Show user pip version
  debug:
    msg: "User pip version: {{ user_pip_version.stdout }}"
